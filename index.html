<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="./style.css" />
    <link rel="icon" type="image/svg+xml" href="./assets/icons/favicon.jpg" />

    <title>IMMIGR NT</title>
    <style>
      .shopify-buy--visually-hidden {
        display: none !important;
      }
      .shopify-buy-frame,
      .shopify-buy__cart-toggle {
        padding: 0px !important;
        margin: 0px !important;
        display: inline !important;
        height: auto !important;
        line-height: 1px !important;
        top: 0 !important;
        bottom: 0 !important;
        border-radius: 0px !important;
        overflow: visible !important;
      }
    </style>
    <!-- Meta Pixel Code -->
    <script>
      !(function (f, b, e, v, n, t, s) {
        if (f.fbq) return;
        n = f.fbq = function () {
          n.callMethod
            ? n.callMethod.apply(n, arguments)
            : n.queue.push(arguments);
        };
        if (!f._fbq) f._fbq = n;
        n.push = n;
        n.loaded = !0;
        n.version = "2.0";
        n.queue = [];
        t = b.createElement(e);
        t.async = !0;
        t.src = v;
        s = b.getElementsByTagName(e)[0];
        s.parentNode.insertBefore(t, s);
      })(
        window,
        document,
        "script",
        "https://connect.facebook.net/en_US/fbevents.js"
      );
      fbq("init", "703071995395077");
      fbq("track", "PageView");
    </script>
    <noscript
      ><img
        height="1"
        width="1"
        style="display: none"
        src="https://www.facebook.com/tr?id=703071995395077&ev=PageView&noscript=1"
    /></noscript>
    <!-- End Meta Pixel Code -->
  </head>
  <body class="main-page">
    <!-- <section class="soon">
			<h1 class="soon_heading">SORRY 5 DA WAIT</h1>
			<p>THIS FRIDAY?</p>
			<div><img src="./assets/icons/immigrnt.svg" alt=""></div>
		</section> -->
    <section class="video-section" id="video-section">
      <video
        playsinline
        autoplay
        muted
        loop
        class="background-video"
        id="responsive-video"
      >
        <source
          src="./assets/immi-home.mp4"
          type="video/mp4"
          media="(min-width: 451px)"
        />
        <source
          src="./assets/phone-video.mp4"
          type="video/mp4"
          media="(max-width: 450px)"
        />
        Your browser does not support the video tag.
      </video>

      <!-- Inverted Center Text -->
      <div class="overlay-text">
        <span class="word-left">CLEAN</span>
        <span class="word-right">SLATE +</span>
      </div>

      <!-- Shop Now CTA -->
      <div class="shop-now">SHOP NOW</div>
    </section>

    <header class="header-container">
      <nav class="navbar">
        <button class="burger-menu" id="burger-menu">
          <img src="./assets/icons/burger.svg" alt="Menu" />
        </button>
        <button class="close-menu" id="close-menu">
          <img
            src="./assets/icons/close.svg"
            alt="Close"
            width="20"
            height="20"
          />
        </button>
        <ul class="nav-list" id="nav-list">
          <li class="nav-item">
            <a href="./index.html">shop</a>
          </li>
          <li class="nav-item">
            <a href="https://www.instagram.com/immigr.nt/">instagram</a>
          </li>
          <li class="nav-item">
            <a href="#" id="cart-toggle" class="nav-item"></a>
          </li>
        </ul>
        <a href="./index.html">
          <img class="logo" src="./assets/icons/immigr-nt.svg" alt="" />
        </a>
      </nav>
    </header>
    <main id="products-section">
      <ul class="products">
        <li class="products-item">
          <a href="./pages/short-w.html">
            <img class="products-img" src="./assets/images/shortw.jpg" alt="" />
            <p class="products-title">CS+ Short sleeve white</p>
            <p class="products-price">€65</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/short-b.html">
            <img class="products-img" src="./assets/images/shortb.jpg" alt="" />
            <p class="products-title">CS+ Short sleeve black</p>
            <p class="products-price">€65</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/shorts.html">
            <img class="products-img" src="./assets/images/shorts.jpg" alt="" />
            <p class="products-title">CS+ Shorts</p>
            <p class="products-price">€80</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/hoodie.html">
            <img class="products-img" src="./assets/images/hoodie.jpg" alt="" />
            <p class="products-title">Clean slate hoodie</p>
            <p class="products-price">€125</p>
          </a>
        </li>
        <li class="products-item">
          <a class="product-image-wrapper" href="./pages/longsleeve.html">
            <div class="product-image-wrapper">
              <img
                class="products-img out-of-stock"
                src="./assets/images/long.jpg"
                alt=""
              />
              <div class="out-of-stock-label">OUT OF STOCK</div>
            </div>
            <p class="products-title">Clean slate long sleeve</p>
            <p class="products-price">€75</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/sweatpants.html">
            <img class="products-img" src="./assets/images/pants.jpg" alt="" />
            <p class="products-title">Clean slate sweatpants</p>
            <p class="products-price">€125</p>
          </a>
        </li>
      </ul>
      <div class="bundle-container">
        <div class="line"></div>
        <h2 class="heading">Bundles</h2>
        <div class="line"></div>
      </div>
      <ul class="products products-bundles">
        <li class="products-item">
          <a
            class="product-image-wrapper"
            href="./pages/csplus_bundle_black.html"
          >
            <img
              class="products-img"
              src="./assets/images/cs_bundle_black_1.jpg"
              alt=""
            />
            <p class="products-title">CS+ Bundle Black</p>
            <p class="products-price-discount">€145</p>
            <p class="products-price">€125</p>
          </a>
        </li>
        <li class="products-item">
          <a
            class="product-image-wrapper"
            href="./pages/csplus_bundle_white.html"
          >
            <img
              class="products-img"
              src="./assets/images/cs_bundle_white_1.jpg"
              alt=""
            />
            <p class="products-title">CS+ Bundle White</p>
            <p class="products-price-discount">€145</p>
            <p class="products-price">€125</p>
          </a>
        </li>
        <li class="products-item">
          <a class="product-image-wrapper" href="./pages/full-bundle.html">
            <div class="product-image-wrapper">
              <img
                class="products-img out-of-stock"
                src="./assets/images/full-bundle.png"
                alt=""
              />
              <div class="out-of-stock-label">OUT OF STOCK</div>
            </div>
            <p class="products-title">FULL BUNDLE</p>
            <p class="products-price-discount">€357</p>
            <p class="products-price">€269</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/ls-sw.html">
            <div class="product-image-wrapper">
              <img
                class="products-img out-of-stock"
                src="./assets/images/ls+sw.png"
                alt=""
              />
              <div class="out-of-stock-label">OUT OF STOCK</div>
            </div>
            <p class="products-title">LONG SLEEVE + SWEATPANTS BUNDLE</p>
            <p class="products-price-discount">€218</p>
            <p class="products-price">€179</p>
          </a>
        </li>
        <li class="products-item">
          <a href="./pages/hoodie-sw.html">
            <img
              class="products-img"
              src="./assets/images/hoodie+sw.png"
              alt=""
            />
            <p class="products-title">HOODIE + SWEATPANTS BUNDLE</p>
            <p class="products-price-discount">€278</p>
            <p class="products-price">€219</p>
          </a>
        </li>
      </ul>
    </main>
    <footer>
      <p>
        © 2025 immigrnt. All rights reserved.
        <a href="./pages/tnc.html">Terms & Conditions.</a>
      </p>
    </footer>
  </body>
  <script defer src="./scripts/script.js"></script>
  <script>
    (function () {
      "use strict";

      /* ---------------------------- Config (edit me) ---------------------------- */
      const SHOPIFY_DOMAIN = "a7cpqd-t6.myshopify.com";
      const STOREFRONT_TOKEN = "499807ad1d9398ef053c159d436b2a71";
      const DEFAULT_EUR_MARKET_COUNTRY = "BE"; // your default EUR market country code
      const BUY_BUTTON_SDK =
        "https://sdks.shopifycdn.com/buy-button/latest/buy-button-storefront.min.js";

      /* ------------------------------- Utilities -------------------------------- */

      // Query param override: ?forceCountry=PL  (good for testing)
      function overrideFromQuery() {
        const m = location.search.match(/[?&]forceCountry=([A-Z]{2})/);
        return m ? m[1] : null;
      }

      // Promise that resolves the first time an element matching selector appears
      function waitForElement(selector, root = document) {
        return new Promise((resolve) => {
          const el = root.querySelector(selector);
          if (el) return resolve(el);
          const mo = new MutationObserver(() => {
            const el2 = root.querySelector(selector);
            if (el2) {
              mo.disconnect();
              resolve(el2);
            }
          });
          mo.observe(root, { childList: true, subtree: true });
        });
      }

      // Robust geolocation: query multiple public providers, allow overrides
      async function getCountryCode() {
        try {
          const forced =
            overrideFromQuery() || localStorage.getItem("forceCountry");
          if (forced) {
            console.log("[geo] forced country via query/localStorage:", forced);
            return forced.toUpperCase();
          }
        } catch (e) {
          console.warn("[geo] override check failed:", e);
        }

        const providers = [
          { url: "https://ipwho.is/", pick: (j) => j && j.country_code },
          { url: "https://ipapi.co/json/", pick: (j) => j && j.country_code },
          {
            url: "https://get.geojs.io/v1/ip/geo.json",
            pick: (j) => j && j.country_code,
          },
          {
            url: "https://geolocation-db.com/json/",
            pick: (j) => j && j.country_code,
          },
        ];

        for (const p of providers) {
          try {
            const r = await fetch(p.url, {
              cache: "no-store",
              headers: { Accept: "application/json" },
            });
            console.log("[geo] fetch", p.url, "status:", r.status);
            if (!r.ok) continue;
            const j = await r.json();
            console.log("[geo] response", p.url, j);
            const cc = p.pick(j);
            if (cc && /^[A-Za-z]{2}$/.test(cc)) return cc.toUpperCase();
          } catch (e) {
            console.warn("[geo] provider failed:", p.url, e);
          }
        }

        console.warn(
          "[geo] all providers failed — falling back to default market"
        );
        return null;
      }

      // Only the countries we care about; everyone else → EUR market country
      function pickBuyerCountry(cc) {
        if (cc === "PL") return "PL";
        if (cc === "UA") return "UA";
        return DEFAULT_EUR_MARKET_COUNTRY;
      }

      // Visual price formatting in the cart UI
      function moneyFormatForCountry(cc) {
        switch (cc) {
          case "PL":
            // 1.234,56 zł  (non-breaking space before zł)
            return "{{amount_with_comma_separator}}\u00A0zł";
          case "UA":
            // ₴1.234,56
            return "₴{{amount_with_comma_separator}}";
          default:
            // €1.234,56
            return "€{{amount_with_comma_separator}}";
        }
      }

      // Make the cart’s separate currency code badge match our detected market
      function setCartCurrencyBadge(cc) {
        const map = { PL: "PLN", UA: "UAH" };
        const code = map[cc] || "EUR";

        const setNow = () => {
          const el =
            document.querySelector(".shopify-buy__currency") ||
            document.querySelector('[data-element="cart.currency"]');
          if (el) {
            el.textContent = code;
            return true;
          }
          return false;
        };

        if (!setNow()) {
          new MutationObserver((_, obs) => {
            if (setNow()) obs.disconnect();
          }).observe(document.body, { childList: true, subtree: true });
        }
      }

      // Create a Storefront Cart with buyerIdentity.countryCode and redirect to checkout
      async function forceCheckoutCurrency(cc, cartComponent) {
        const items =
          cartComponent && cartComponent.model && cartComponent.model.lineItems
            ? cartComponent.model.lineItems
            : [];
        if (!items.length) {
          alert("Your cart is empty.");
          return;
        }

        const lines = items.map((li) => ({
          merchandiseId: li.variant.id, // GraphQL GID (gid://shopify/ProductVariant/…)
          quantity: li.quantity,
        }));

        const mutation = `
      mutation CreateCart($lines:[CartLineInput!], $buyer: CartBuyerIdentityInput) {
        cartCreate(input:{ lines: $lines, buyerIdentity: $buyer }) {
          cart { checkoutUrl }
          userErrors { message }
        }
      }
    `;

        try {
          const res = await fetch(
            `https://${SHOPIFY_DOMAIN}/api/2025-01/graphql.json`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Accept: "application/json",
                "X-Shopify-Storefront-Access-Token": STOREFRONT_TOKEN,
              },
              body: JSON.stringify({
                query: mutation,
                variables: { lines, buyer: { countryCode: cc } },
              }),
            }
          );

          const json = await res.json();
          console.log("[checkout] cartCreate response:", json);

          const url = json?.data?.cartCreate?.cart?.checkoutUrl;
          if (!url) {
            const msg =
              (json?.data?.cartCreate?.userErrors || [])
                .map((e) => e.message)
                .join(", ") || "Unknown error";
            alert("Could not start checkout: " + msg);
            return;
          }
          window.location.href = url;
        } catch (err) {
          console.error("[checkout] cartCreate failed:", err);
          alert("Something went wrong starting checkout.");
        }
      }

      // Ensure Buy Button SDK present; then run ShopifyBuyInit
      function ensureBuyButtonSdk() {
        return new Promise((resolve) => {
          if (window.ShopifyBuy && window.ShopifyBuy.UI) return resolve();
          const s = document.createElement("script");
          s.async = true;
          s.src = BUY_BUTTON_SDK;
          s.onload = () => resolve();
          (document.head || document.body).appendChild(s);
        });
      }

      /* --------------------------- Main initialization -------------------------- */

      async function ShopifyBuyInit() {
        console.log("[init] start");

        await ensureBuyButtonSdk();

        const rawCC = (await getCountryCode()) || DEFAULT_EUR_MARKET_COUNTRY;
        const buyerCC = pickBuyerCountry(rawCC);
        const moneyFmt = moneyFormatForCountry(buyerCC);

        console.log("[init] geo:", { rawCC, buyerCC, moneyFmt });

        // Ensure there is a cart toggle anchor in the nav (if not present)
        let toggleNode = document.getElementById("cart-toggle");
        if (!toggleNode) {
          toggleNode = document.createElement("a");
          toggleNode.id = "cart-toggle";
          toggleNode.href = "#";
          toggleNode.textContent = "cart (0)";
          document.body.appendChild(toggleNode);
        }

        const client = ShopifyBuy.buildClient({
          domain: SHOPIFY_DOMAIN,
          storefrontAccessToken: STOREFRONT_TOKEN,
        });

        // Build the cart component
        window.ShopifyBuy.UI.onReady(client).then(async function (ui) {
          const cart = ui.createComponent("cart", {
            toggles: [{ node: toggleNode }],
            moneyFormat: moneyFmt, // visual formatting per visitor
            options: {
              toggle: {
                sticky: false,
                iframe: false,
                templates: {
                  icon: "",
                  count:
                    '<span class="{{data.classes.toggle.count}}" data-element="toggle.count">cart ({{data.count}})</span>',
                },
              },
              cart: {
                styles: {
                  button: {
                    ":hover": {
                      color: "#222222",
                      "background-color": "#fff",
                      border: "1px solid #222222",
                    },
                    "background-color": "#222222",
                  },
                  title: { color: "#252525" },
                  header: { color: "#252525" },
                  lineItems: { color: "#252525" },
                  subtotalText: { color: "#252525" },
                  subtotal: { color: "#252525" },
                  notice: { color: "#252525" },
                  currency: { color: "#252525" },
                  close: { color: "#252525", ":hover": { color: "#252525" } },
                  empty: { color: "#252525" },
                  noteDescription: { color: "#252525" },
                  discountText: { color: "#252525" },
                  discountIcon: { fill: "#252525" },
                  discountAmount: { color: "#252525" },
                },
                text: {
                  title: "CART",
                  total: "TOTAL",
                  empty: "BUY SUM!",
                  notice: "",
                  button: "TO CHECKOUT!",
                },
                popup: false,
              },
            },
          });

          // Update the cart currency badge (EUR/PLN/UAH) to match detected market
          setCartCurrencyBadge(buyerCC);

          // Intercept checkout button to force the checkout currency via Storefront Cart
          const buttonSelector =
            ".shopify-buy__btn--cart-checkout, .shopify-buy__cart-checkout-button";

          const checkoutBtn = await waitForElement(buttonSelector);
          checkoutBtn.addEventListener("click", function (e) {
            e.preventDefault();
            e.stopPropagation();
            forceCheckoutCurrency(buyerCC, cart);
          });

          console.log("[init] cart ready; checkout hooked");
        });
      }

      // Kick things off after DOM is interactive. (Script is deferred, but this is safe.)
      if (document.readyState === "loading") {
        document.addEventListener("DOMContentLoaded", ShopifyBuyInit);
      } else {
        ShopifyBuyInit();
      }
    })();
  </script>
</html>
